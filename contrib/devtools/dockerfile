# syntax=docker/dockerfile:1

FROM bufbuild/buf:latest as builder

FROM golang:1.18-alpine

RUN apk add --no-cache git build-base bash ca-certificates curl tar

ENV GOBIN=/usr/local/bin
ENV PATH=$GOBIN:$PATH

ENV GOLANG_PROTOBUF_VERSION=1.3.5 \
    GOGO_PROTOBUF_VERSION=1.3.2 \
    GRPC_GATEWAY_VERSION=1.14.7 \
    PROTOC_GEN_DOC_VERSION=1.5.1


RUN set -eux; \
  mkdir -p /tmp/proto-tools && cd /tmp/proto-tools; \
  git clone --depth 1 --branch v${GOLANG_PROTOBUF_VERSION} https://github.com/golang/protobuf; \
  cd protobuf/protoc-gen-go; \
  go build -o /usr/local/bin/protoc-gen-go; \
  cd /; rm -rf /tmp/proto-tools

RUN set -eux; \
  mkdir -p /tmp/proto-tools && cd /tmp/proto-tools; \
  git clone --depth 1 --branch v${GOGO_PROTOBUF_VERSION} https://github.com/gogo/protobuf; \
  cd protobuf/protoc-gen-gogo && go build -o /usr/local/bin/protoc-gen-gogo; \
  cd ../protoc-gen-gofast && go build -o /usr/local/bin/protoc-gen-gogofast; \
  cd ../protoc-gen-gogofaster && go build -o /usr/local/bin/protoc-gen-gogofaster; \
  cd /; rm -rf /tmp/proto-tools

RUN set -eux; \
  mkdir -p /tmp/proto-tools && cd /tmp/proto-tools; \
  git clone --depth 1 --branch v${GRPC_GATEWAY_VERSION} https://github.com/grpc-ecosystem/grpc-gateway; \
  cd grpc-gateway/protoc-gen-grpc-gateway && go build -o /usr/local/bin/protoc-gen-grpc-gateway; \
  cd ../protoc-gen-swagger && go build -o /usr/local/bin/protoc-gen-swagger; \
  cd /; rm -rf /tmp/proto-tools

RUN set -eux; \
  curl -sSL https://github.com/pseudomuto/protoc-gen-doc/releases/download/v${PROTOC_GEN_DOC_VERSION}/protoc-gen-doc_${PROTOC_GEN_DOC_VERSION}_linux_amd64.tar.gz \
  | tar xz -C /usr/local/bin protoc-gen-doc

RUN apk add --no-cache nodejs npm && npm install -g swagger-combine

COPY --from=builder /usr/local/bin /usr/local/bin

WORKDIR /workspace
